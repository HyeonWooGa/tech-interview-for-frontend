# 쿠키와 세션
## 쿠키와 세션을 사용하는 이유

HTTP 프로토콜에는 비연결성과 비상태성이라는 특징이 있다. 모든 사용자의 요청마다 연결과 해제의 과정을 거치면서 연결 상태를 유지하지 않고, 연결 해제 후에도 상태 정보를 저장하지 않기 때문에 서버의 자원을 크게 절약할 수 있다. 하지만 이로 인해 사용자를 식별할 수 없어 같은 사용자가 요청을 여러번 하더라도 매번 새로운 사용자로 인식하는 단점이 있다.

하지만 우리가 사용하고 있는 웹사이트를 생각해보면 로그인을 한번 하고나면, 그 사이트에서는 다시 로그인할 필요 없이 여러 페이지의 기능들을 이용할 수 있고, 심지어 브라우저를 종료했다 다시 접속했을 때도 로그인 상태를 유지할 수 있다.

이런 **HTTP의 비상태, 비연결의 특성들을 보완한 기술이 쿠키와 세션이다.**

<br>

# 쿠키 (Cookie)

> 서버가 사용자의 웹브라우저에 저장하는 데이터

쿠키는 서버를 대신해서 사용자 정보 같은 정보들을 웹 브라우저에 저장하고, 사용자가 요청할 때 그 정보를 함께 보내서 서버가 사용자를 식별할 수 있게 해준다.

이로써 로그인 기능도 이용할 수 있고 사용자에 맞게 사용자마다 다른 정보를 제공할 수 있게 된다.

쿠키의 데이터 형태는 key와 value로 구성되고, String으로만 이루어져 있다. 4KB 이상 저장할 수 없다.

### 쿠키를 사용하는 목적

1. 세션 관리 : 로그인, 사용자 닉네임, 접속 시간, 장바구니 등의 서버가 알아야할 정보들을 저장한다.

1. 개인화 : 사용자마다 다르게 그 사람에 적절한 페이지를 보여줄 수 있다.

1. 트래킹 : 사용자의 행동과 패턴을 분석하고 기록한다.

### 쿠키 동작 과정

1. 서버가 클라이언트로부터 요청(request)을 받았을 때, 클라이언트에 관한 정보를 파일이나 문자열로 저장한다.
2. 서버는 클라이언트에게 보내는 응답(response)에 쿠키를 포함한다.
3. 클라이언트가 응답을 받으면, 브라우저는 도메인 서버 이름으로 정렬되는 쿠키 디렉터리에 쿠키를 저장한다.

### 쿠키의 용도

쿠키가 있기 때문에 **여러 페이지를 이동할 때마다 로그인을 하지 않고도 사용자 정보를 유지**할 수 있다. (쿠키가 없다면 다음 페이지로 사용자 정보를 넘겨줘야 한다)

- ID 저장, 로그인 상태 유지
- 7일간 다시 보지 않기 (쿠키에 체크한 날짜를 기록하여 다시 방문했을 때의 시간과 시차를 이용해 계산)
- 최근 검색한 상품들을 광고에서 추천
- 쇼핑몰 장바구니 기능

<br>

# 세션 (Session)

> 서버에 저장되는 쿠키. 주로 중요한 데이터를 저장할 때 사용

페이지를 이동해도 사용자의 로그인 상태를 유지하는 기능을 생각해 봅시다. 앞서 살펴본 쿠키를 이용해서 사용자의 아이디와 비밀번호를 쿠키에 저장한다고 가정해 봅시다. 페이지를 이동하여도 쿠키를 통해 아이디와 비밀번호를 서버에 전달해서 서버에서는 사용자를 식별하여 해당 사용자의 로그인 상태를 유지시킬 수 있습니다.

하지만 이렇게 쿠키만을 이용하여 인증을 구현하면 쿠키가 유출, 조작 될 수 있는 보안상 매우 큰 문제가 됩니다. 개인 소유가 아닌 컴퓨터에서 사용할 경우 누구나 그 사용자의 비밀번호를 확인할 수 있고 HTTP로 개인 정보를 주고 받는 것은 매우 위험합니다.

세션은 비밀번호와 같은 인증 정보를 쿠키에 저장하지 않고, 대신 사용자 식별자인 `세션ID`를 저장한다. 서버에는 인증 정보와 더불어 이 ID에 해당하는 로그인 상태, 마지막 로그인 시간, 닉네임, 만료기한 등의 정보를 저장한다. 보안상 서버는 사용자의 개인 컴퓨터보다는 훨씬 안전하기 때문에 인증에 세션을 이요한다.

- 사용자 로컬이 아닌 서버에 직접 저장되므로 세션 내의 데이터 탈취가 어렵다. → 보안성이 높음

### 세션 동작 과정

1. 클라이언트가 서버에 처음으로 Request를 보냄 (첫 요청이기 때문에 session id가 존재하지 않음)
2. 서버에서는 session id 쿠키 값이 없는 것을 확인하고 새로 발급해서 응답
3. 이후 클라이언트는 전달받은 session id 값을 매 요청마다 헤더 쿠키에 넣어서 요청
4. 서버는 session id를 확인하여 사용자를 식별
5. 클라이언트가 로그인을 요청하면 서버는 session을 로그인한 사용자 정보로 갱신하고 새로운 session id를 발급하여 응답
6. 이후 클라이언트는 로그인 사용자의 session id 쿠키를 요청과 함께 전달하고 서버에서도 로그인된 사용자로 식별 가능
7. 클라이언트 종료 (브라우저 종료) 시 session id 제거, 서버에서도 세션 제거

### 세션의 특징

- 세션 ID는 브라우저 단위로 저장되고 브라우저 종료시 소멸된다.
- 로그인한 사용자에 대해서만 세션을 생성하는게 아니라 로그아웃하면 새로운 사용자로 인식해 새로운 세션이 생성된다.
- 사용자가 로그인 했는지, 닉네임 등의 사용자가 요청할때마다 필요한 정보들을 세션에 담아두면 사용자 디비에 접근할 필요가 없어 효율적이다.

### 세션이 탈취당했을 때

세션 ID를 취득해서 특정 컴퓨터에서 그 세션ID를 쿠키에 적용시키고, 해당 사이트에 접속하면 원래 세션 ID를 가진 사용자로 접근할 수 있겠죠..

<br>

# 쿠키와 세션의 차이점

- 쿠키는 클라이언트에, 세션은 서버에 저장된다.
- 세션은 서버에 저장되므로 속도가 쿠키보다 느리다.
- 쿠키는 보안성에 취약하고 세션은 비교적 보안성이 좋다.

<br>

# 보안

누군가 어떤 사용자의 세션 아이디를 훔친다면, 그 사용자처럼 로그인할 수 있게 된다. https를 이용해 통신하는게 좋고, 쿠키와 마찬가지로 세션의 옵션으로 secure을 true로 주면 https에서만 세션 정보를 주고받을 수 있다. 또한, HttpOnly를 true로 주면 javascript를 통해 세션 쿠키를 사용할 수 없도록 강제할 수 있다.

<br>

# 결론

`쿠키`는 브라우저에 사용자 정보가 기록되기 때문에 위변조의 가능성이 높아 보안에 취약하며, `세션` 또한 서버의 메모리를 차지하고 있기 때문에 동접자가 많은 웹사이트일 경우 서버 과부화의 원인이 되며, 세션 정보가 중간에 탈취당할 수 있어 보안에 완벽하다고 할 수 없다.

쿠키와 세션의 이러한 문제점들을 보완하기 위해 토큰 기반의 인증 방식이 도입되었다.

<br>

## 참고
- [쿠키(Cookie)와 세션(Session) & 로그인 동작 방법 | blog](https://cjh5414.github.io/cookie-and-session/)
- [쿠키( Cookie )와 세션( Session ) | victory](https://victorydntmd.tistory.com/34)
- [JWT (JSON Web Token) | victory](https://victorydntmd.tistory.com/115)